<!DOCTYPE html>
<html>
<head>
    <title>GPT Your Data</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap');

        body {
            font-family: 'Roboto', sans-serif;
            margin-left: 30px;
            max-width: 1000px;
        }

        .loading {
            display: none;
            margin-top: 20px;
            text-align: center;
        }

        .loading::after {
            content: "";
            display: inline-block;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        #resultDiv {
            margin-top: 20px;
        }

        #conversationDiv {
            margin-top: 20px;
        }

        #conversationDiv p {
            margin-bottom: 10px;
        }

        #clearButton {
            margin-top: 10px;
        }

        .collapsible {
            cursor: pointer;
            padding: 12px;
            width: 100%;
            border: none;
            text-align: left;
            outline: none;
            font-size: 15px;
            transition: 0.4s;
        }

        .content {
            padding: 0 18px;
            overflow: hidden;
            background-color: #f1f1f1;
        }

        .collapsed {
            display: none;
        }
    </style>
</head>
<body>
<h1>GPT Your Data</h1>
<a href="https://github.com/andresdelcampo/GPTYourData">GPTYourData</a> is a simple but fast and effective C# vector search engine that utilizes OpenAI's GPT models for generating embeddings and answering questions based on local files. 
It logs the questions so that unanswered ones may be added to the knowledge base over time.<br><br>
<b>WARNING:</b> It may produce inaccurate information.<br><br>
<form id="queryForm">
    <label for="queryInput">Question:</label>
    <input type="text" id="queryInput" name="queryInput">
    <button type="submit">Ask</button>
    <div id="resultDiv"></div>
    <div id="loadingDiv" class="loading"></div>
    <div id="conversationDiv"></div>
    <button id="clearButton">Clear</button>
    <br><br>
    <label for="fileUpload">You can also contribute a .txt file to the knowledge base:</label>
    <input type="file" id="fileUpload" name="fileUpload" accept=".txt">
    <button type="button" id="uploadButton">Upload File</button>
    <div id="messageDiv"></div>
</form>
<br>
<button class="collapsible" onclick="toggleCollapse()">Sample questions and suggestions (click to toggle)</button>
<div id="contentContainer" class="content collapsed">
    Sample questions:
    <ul>
        <li>Enter your sample questions here</li>
        <li>...</li>
    </ul>
    If you have questions or suggestions about this tool, please raise them in <a href="https://github.com/andresdelcampo/GPTYourData">GPTYourData</a>.<br><br>
    <b>NEW:</b> You can now upload TXT files yourself from this page and query them right away!<br><br>
</div>

<script>
    const form = document.getElementById("queryForm");
    const queryInput = document.getElementById("queryInput");
    const resultDiv = document.getElementById("resultDiv");
    const loadingDiv = document.getElementById("loadingDiv");
    const conversationDiv = document.getElementById("conversationDiv");
    const clearButton = document.getElementById("clearButton");
    const fileUpload = document.getElementById("fileUpload");
    const uploadButton = document.getElementById("uploadButton");
    const messageDiv = document.getElementById("messageDiv");
    
    form.addEventListener("submit", function(event) {
        event.preventDefault();
        const query = queryInput.value;

        // Show loading spinner
        loadingDiv.style.display = "block";

        fetch("/api/gptquery", {
            method: "POST",
            headers: {
                "Content-Type": "application/x-www-form-urlencoded"
            },
            body: "query=" + encodeURIComponent(query)
        })
            .then(response => response.text())
            .then(result => {
                const questionAnswer = document.createElement("p");
                questionAnswer.innerHTML = `<strong>Question:</strong> ${query}<br><strong>Answer:</strong> ${result}`;
                conversationDiv.appendChild(questionAnswer);
            })
            .catch(error => {
                const errorMessage = document.createElement("p");
                errorMessage.innerText = `An error occurred: ${error}`;
                conversationDiv.appendChild(errorMessage);
            })
            .finally(() => {
                // Hide loading spinner
                loadingDiv.style.display = "none";
            });

        // Clear input field
        queryInput.value = "";
    });

    fileUpload.addEventListener("change", function() {
        // Clear the message
        messageDiv.innerHTML = "";
    })
    
    uploadButton.addEventListener("click", function() {
        const fileToUpload = fileUpload.files[0];  // Get the selected file

        // Create a FormData instance
        const formData = new FormData();
        formData.append("file", fileToUpload);   // Append the file

        // Check the file size
        const fileSize = fileToUpload.size / 1024 / 1024; // size in MB
        if (fileSize > 1) {
            messageDiv.innerHTML = "The selected file is too large. Please select a file smaller than 1MB.";
            return;
        }
        
        fetch("/api/gptquery", {
            method: "POST",
            body: formData  // Send the FormData object
        })
            .then(response => {
                if (!response.ok) {
                    // The HTTP status code is 4xx or 5xx
                    // Use the json() method to parse the JSON in the response
                    return response.json().then(errorJson => {
                        // Throw an Error with the detail in the JSON response
                        throw new Error(errorJson.detail);
                    });
                }
                return response.text();
            })
            .then(data => {
                // Handle the response by updating the message div
                messageDiv.innerHTML = "File uploaded successfully. You should be able to query the new data now.";

                // Clear the message after 5 seconds
                setTimeout(() => {
                    messageDiv.innerHTML = "";
                }, 5000);
            })
            .catch(error => {
                // Handle any errors by updating the message div
                messageDiv.innerHTML = "An error occurred: " + error.message;
            });

        // Clear file field
        fileUpload.value = "";
    });
    
    clearButton.addEventListener("click", function() {
        // Clear conversation
        conversationDiv.innerHTML = "";
    });

    function toggleCollapse() {
        var contentContainer = document.getElementById("contentContainer");
        contentContainer.classList.toggle("collapsed");
    }
</script>
</body>
</html>
